(function(l,o){var j=window,H=document,y=QNR,A,h,F=[],C=[],E=false,B=false;y=y||{};y.isLoad=false;var x;var t;var g;var r;var b=function(J){var I=new Date();if(J){I.setTime(J);}var q=function(K){if(/^\d$/.test(K)){return"0"+K;}return K;};return I.getFullYear()+"-"+q(parseInt(I.getMonth()+1))+"-"+q(I.getDate());};var m={};var G={};G.doScroll=function(M,L){var J=H.body.scrollTop||H.documentElement.scrollTop||window.pageYOffset||0;var N=window.innerHeight||H.documentElement.clientHeight;for(var K=0,q=M.length;K<q;K+=1){if(Math.abs(I(M[K])-J)<N){y.isLoad=true;return L();}}function I(P){if(!P){return;}var O=P.offsetTop;if(P.offsetParent){while(P=P.offsetParent){O+=P.offsetTop;}}return O;}};G.init=function(J,I){var q=this;q.doScroll(J,I);window.onscroll=function(){if(!y.isLoad){q.doScroll(J,I);}return false;};};var d=function(q){X.merge(this,q);};d.prototype={sort:function(q,J){var I=this.prices;I.sort(function(K,L){if(J){return(parseInt(L[q])-parseInt(K[q]));}else{return(parseInt(K[q])-parseInt(L[q]));}});},sortByPrice:function(q){this.sort("price",q);},sortByTime:function(q){this.sort("updated");},getGift:function(q){if(this.gifts[q]){return this.gifts[q]["pt"];}return"";},filter:function(L,N,J){var I=[];var M=this.prices;for(var K=0,q=M.length;K<q;K+=1){if(M[K][L]==N^J){I.push(M[K]);}}this.prices=I;},filterByCompany:function(){var J=[];var L=this.prices;var K=["wiagodacn00","11b05af5aca","1098d646f0b","wielong0000","wimangocity"];for(var I=0;I<K.length;I++){for(var q=0;q<L.length;q++){if(K[I]==L[q].vendor){J.push(L[q]);this.prices=J;}}}},filterByCluster:function(q){return this.filter("cluster",q);},filterByRoom:function(q){return this.filter("room",q);},filterByVendor:function(q){return this.filter("vendor",q,true);},disByRoom:function(){var L=this.prices;var q=L.length;for(var K=0;K<q;K++){var I=L[K].room;for(var J=K+1;J<q;J++){if(I===L[J].room){L.splice(J,1);q-=1;}}}this.prices=L;}};var w=function(q){X.merge(this,q);};w.prototype={getVendor:function(q){return this[q];}};y=y.hotel={render:function(I){if(!I.hotels[y.team.seq]){return;}var K=new d(I.hotels[y.team.seq]);var M=new w(I.vendors);var q=y.team.hotel_type;K.filterByCluster(y.team.room_type);K.filterByVendor("wituanhotel");K.filterByCompany();K.sortByPrice();if(K.prices.length<1){t=false;return false;}K.disByRoom();var L=0;var J="";t=true;G.init(l("#content_tab"),function(){var U=[];U.push('<section class="prbjline cf">');U.push('<hgroup class="y_title">');U.push("    价格比较");U.push("</hgroup>");if(q=="normal"||q=="multi"){if(y.team.card>0&&y.team.card){L=y.team.card;J="<li>-&yen;"+y.team.card+y.team.cardname+"</li>";}var R=(parseFloat(y.team.baojian_total)>0&&q=="multi")?parseFloat(y.team.baojian_total):1;U.push('<article class="tuanprice mt4">');U.push('<h2>团购价<span class="pr">&yen;'+(parseFloat(y.team.price)/R)+"</span></h2>");U.push('<ul class="price_list f14">');U.push("<li>"+I.hotels[y.team.seq].attrs.hotelName+"住宿1天</li>");U.push("<li>"+y.team.room_type+"</li>");U.push(J);if(("end" in y.team&&!y.team.end)){U.push('<li class="cf"><a class="btn1 fR" href="/team/buy.php?in_track=detailpk&id='+X.params("?id="+y.team.id).id+'" alt="抢购">抢购</a></li>');}U.push("</ul>");U.push("</article>");U.push('<figure class="pk">');U.push('    <p class="pk_text">pK</p>');U.push("</figure>");U.push('<article class="inter_price mt4">');U.push('<h2><span class="pr">&yen;'+K.prices[0].price+"</span><cite>起</cite>网络价</h2>");U.push('<ul class="price_list f14">');for(var T=0,O;(O=K.prices[T++])&&T<=5;){var P={price:parseFloat(O.oprice)!=0?(parseFloat(O.price)+parseFloat(O.oprice))+"&nbsp;"+(parseFloat(O.oprice)>0?"-":"+")+"&nbsp;&yen;"+Math.abs(O.oprice):O.price,tip:(/^(.{9,})$/).test(O.room)?O.room.match(/^.{1,8}/)[0]+"...":O.room,otip:O.room,type:O.cluster,vendor:M.getVendor(O.vendor).name,more:parseFloat(O.oprice)!=0?(parseFloat(O.oprice)>0?"所减":"所加")+Math.abs(O.oprice)+"元为"+K.getGift(O.vendor):""};U.push(X.template('<li>{otip}<span class="room">&yen;{price}</span><span class="pr">{more}</span></li>',P));}U.push("</ul>");U.push("</article>");}else{if(q=="gift_packet"){if(y.team.card>0&&y.team.card){L=y.team.card;J="<li>-&yen;"+y.team.card+y.team.cardname+"</li>";}U.push('<article class="tuanprice mt4">');U.push('<h2>团购价<span class="pr">&yen;'+(parseFloat(y.team.price))+"</span></h2>");U.push('<ul class="price_list f14">');U.push('<li><span class="icon_gift"></span>'+I.hotels[y.team.seq].attrs.hotelName+"住宿1天");U.push('    	<ul class="price_inct">');var W=y.team.room_desc||"";var Q=W.split("|");var N="";var Z="";var S=0;for(var T=0,V=Q.length;T<V;T+=1){if(Q[T]){var Y=Q[T].split("~");if(Y){N+="<li>"+Y[0]+"</li>";Z+="<li>"+Y[0]+'<span class="pr">&yen;'+Y[1]+"</span></li>";S+=parseFloat(Y[1]);}}}U.push(N);U.push("     </ul>    ");U.push("</li>");U.push("<li>"+y.team.room_type+"</li>");U.push(J);if(("end" in y.team&&!y.team.end)){U.push('<li class="cf"><a class="btn1 fR" href="/team/buy.php?in_track=detailpk&id='+X.params("?id="+y.team.id).id+'" alt="抢购">抢购</a></li>');}U.push("</ul>");U.push("</article>");U.push('<figure class="pk">');U.push('    <p class="pk_text">pK</p>');U.push("</figure>");U.push('<article class="inter_price mt4">');U.push('<h2><span class="pr">&yen;'+(parseFloat(K.prices[0].price)+S)+"</span><cite>起</cite>网络价</h2>");U.push('<ul class="price_list f14">');U.push('	<li>酒店住宿网络预订价<span class="pr">&yen;'+(K.prices.length===1?K.prices[0].price:(K.prices[0].price+"-&yen;"+(K.prices.length>5?K.prices[4].price:K.prices[K.prices.length-1].price)))+"</span>");U.push('    	 <ul class="price_dotct f12">');for(var T=0,O;(O=K.prices[T++])&&T<=5;){var P={price:parseFloat(O.oprice)!=0?(parseFloat(O.price)+parseFloat(O.oprice))+"&nbsp;"+(parseFloat(O.oprice)>0?"-":"+")+"&nbsp;&yen;"+Math.abs(O.oprice):O.price,tip:(/^(.{9,})$/).test(O.room)?O.room.match(/^.{1,8}/)[0]+"...":O.room,otip:O.room,type:O.cluster,vendor:M.getVendor(O.vendor).name,more:parseFloat(O.oprice)!=0?(parseFloat(O.oprice)>0?"所减":"所加")+Math.abs(O.oprice)+"元为"+K.getGift(O.vendor):""};U.push(X.template('<li><span class="black_box"></span>{otip} | <span class="info">&yen;{price}</span>&nbsp; |&nbsp; {more}</li>',P));}U.push("         </ul>");U.push("    </li>");U.push(Z);U.push("</ul>");U.push("</article>");}else{if(q=="voucher"){U.push('<article class="tuanprice mt4">');U.push('<h2>团购价<span class="pr">&yen;'+(parseFloat(y.team.price)+parseFloat(y.team.voucher_val))+"</span></h2>");U.push('<ul class="price_list f14">');U.push("<li>"+I.hotels[y.team.seq].attrs.hotelName+"住宿1天</li>");U.push("<li>"+y.team.room_type+"</li>");U.push("<li>"+parseFloat(y.team.market_price)+'元代金券<span class="pr">&yen;'+parseFloat(y.team.price)+"</span></li>");U.push('<li>持券住酒店需付现金<span class="pr">&yen;'+parseFloat(y.team.voucher_val)+"</span></li>");U.push("</ul>");U.push("</article>");U.push('<figure class="pk">');U.push('    <p class="pk_text">pK</p>');U.push("</figure>");U.push('<article class="inter_price mt4">');U.push('<h2><span class="pr">&yen;'+K.prices[0].price+"</span><cite>起</cite>网络价</h2>");U.push('<ul class="price_list f14">');for(var T=0,O;(O=K.prices[T++])&&T<=5;){var P={price:parseFloat(O.oprice)!=0?(parseFloat(O.price)+parseFloat(O.oprice))+"&nbsp;"+(parseFloat(O.oprice)>0?"-":"+")+"&nbsp;&yen;"+Math.abs(O.oprice):O.price,tip:(/^(.{9,})$/).test(O.room)?O.room.match(/^.{1,8}/)[0]+"...":O.room,otip:O.room,type:O.cluster,vendor:M.getVendor(O.vendor).name,more:parseFloat(O.oprice)!=0?(parseFloat(O.oprice)>0?"所减":"所加")+Math.abs(O.oprice)+"元为"+K.getGift(O.vendor):""};U.push(X.template('<li>{otip}<span class="room">&yen;{price}</span><span class="pr">{more}</span></li>',P));}U.push("</ul>");U.push("</article>");}}}U.push("</section>");l(".hotel_pk").html(U.join("")).show();});if(typeof r!="undefined"){clearTimeout(r);}r=window.setTimeout(function(){if(t){y.getResult(g,"PK");}},120*1000,true);},getResult:function(L,K,q){g=L;L=L.split("_");var J=new Date(parseInt(y.team.curtime)*1000).getTime();var M=new Date(parseInt(y.team.checkin_time)*1000||J);M=J>M.getTime()?J:M.getTime();y.team.seq=L.pop();if(K=="PK"){var I="http://hotel.qunar.com/price/api.jsp?requestor=RT_GROUP&cityurl="+L.join("_")+"&fromDate="+b(M)+"&showPrices=1&toDate="+b(M+3600*24*1*1000)+"&ids="+y.team.seq+"&output=json&attrs=L0F4L3C1&__jscallback=QNR.hotel.render&showFullRoom=1&_v="+(new Date().getTime());}else{if(K=="around"){var I="http://hotel.qunar.com/price/api.jsp?requestor=RT_GROUP&cityurl="+L.join("_")+"&fromDate="+b(M)+"&showAround=1&toDate="+b(M+3600*24*1*1000)+"&ids="+q+"&__jscallback=QNR.hotel.hotel_around&showWrapperPhone=1&_v="+(new Date().getTime());}}X.loadBase(I);},getTeam:function(J,I,q){q=q||l("#first_hotel").find("span").attr("data-itemid");y.hotelid=q;l.get("/ajax/team.php?action=hotelcompare",{id:J},function(N){try{var M=N||{};y.team=M.data.data;y.team.id=J;M=y.team.seq;var L=M.split(",");}catch(O){return false;}var K=l("#hide_room_type").val();if(!!L[0]){if(K=="N"&&!!y.team.room_type){if(I=="init"){y.getResult(L[0],"PK");}}y.hotelid&&y.getResult(L[0],"around",y.hotelid);return true;}return false;},"json");}};y.hotel_around=function(M){if(!M.hotels[y.hotelid]){return;}var L=M.hotels[y.hotelid].around;var q=k=0;for(var J in L){if(L[J].length==0){k++;}q++;}if(q==k){return;}var I=[];I.push('<div class="hotel_round">');I.push('<div class="tab_head">');I.push("<h3>酒店周边：</h3>");I.push('<div class="tabtitle">');I.push('<ul class="cf able-switchable-nav">');var N=["机场车站","美食","景点","休闲娱乐"];var q=0;for(var J in L){if(L[J].length>0){var K=(q==3?' class="last"':"");I.push("<li"+K+'><span class="tabname">'+N[q]+'</span><b class="down_jt"></b></li>');}q++;}I.push("</ul>");I.push("</div>");I.push("</div>");I.push('<div class="able-switchable-content">');for(var J in L){if(L[J].length>0){I.push('<ul class="tab_content cf" style="display:none;">');for(var q=0;q<L[J].length;q++){I.push("<li>"+L[J][q].name+"</li>");}I.push("</ul>");}}I.push("</div>");I.push("</div>");if(l(".hotel_round").length>0){l(".hotel_round").remove();}if(l("#partner_addr")){l(I.join("")).appendTo("#partner_addr");}l(".hotel_round").switchable({activeTriggerCls:"curr",events:["click"]});};var f=l("#shop_page > .traffic > dl > dd");i(f);m.shop={};m.shop.change=function(J,I){l("#shop_page").load("shop_page.php",{shop_id:J},function(){var K;if(I){l("#hotelname").find("li").removeClass("current");l(I).parent().addClass("current");}E=true;mapCallback();l("#hotelname li").each(function(L,M){if(l(M).hasClass("current")){K=L;}});c();z(K);if(E){u(F);F=[];E=false;}});var q=l("#team_id").val();if(!QNR.hotel.getTeam(q,"around",J)){l(".hotel_round").remove();}};m.shop.init=function(){l("#hotelname").delegate("span","click",function(){m.shop.change(l(this).attr("data-itemid"),this);});};m.city_tab={};m.city_tab.change=function(I,J){var K=l("#partner_id").val();var q="/ajax/team.php?action=get_partner_shop&partner_id="+K+"&place="+encodeURIComponent(I)+"&from=p_shop";l.get(q,function(L){try{var T=L||{};var O=T.data.data;l(J).parent().find("dd").removeClass("current");l(J).addClass("current");var M=[];for(var P=0,Q=O.length;P<Q;P+=1){var S=(P==0)?'class="current"':"";M.push("<li "+S+'><span data-itemid="'+O[P].id+'">'+O[P].title+"</span></li>");}l("ul.map_tabcontent").css("left",0);l("ul.map_tabcontent").html(M.join(""));if(O.length>5){if(l("#maptt_tab").data("switchables")){l("#maptt_tab").data("switchables").length=0;}var N=l("#maptt_tab").switchable({effect:"scrollx",step:1,viewportLen:5,circle:true});l("#prev_next").css("display","block");l(".prev").click(function(){N.data("switchables")[0].prev();});l(".next").click(function(){N.data("switchables")[0].next();});}else{l(".prev").unbind("click");l(".next").unbind("click");l("#prev_next").css("display","none");}if(O.length>0){m.shop.change(O[0].id);l("#shop_page").css("display","block");l("section.hotel_round").css("display","block");}else{l("#shop_page").css("display","none");l("section.hotel_round").css("display","none");}}catch(R){return false;}},"json");};m.city_tab.init=function(){var J=l(".city_tab");var I=l(".city_tab .list");var q=l(".city_tab > dl > dd");if(q.length>1){q.bind("click",function(){m.city_tab.change(l(this).html(),this);});}J.undelegate().delegate(".more","click",function(K){I.toggle();if(I.css("display")=="block"){l(this).addClass("on");}else{l(this).removeClass("on");}});l(".list_hotcity").undelegate().delegate("li","click",function(K){q.last().html(l(this).html());q.last().trigger("click");I.hide();J.find(".more").removeClass("on");});};var v=function(I,J){A=new BMap.Map(I);var q=new BMap.Geocoder();q.getPoint(J,function(K){if(K){A.centerAndZoom(new BMap.Point(K.lng,K.lat),11);}},J);};function c(){for(var I=0,q=F.length;I<q;I+=1){A.addOverlay(F[I]);F[I].addEventListener("click",D);}}function u(I){for(var J=0,q=I.length;J<q;J+=1){A.removeOverlay(I[J]);I[J].dispose();}}function e(K){for(var I=0,q=F.length;I<q;I+=1){if(K.guid!=F[I].guid){var J=new BMap.Icon("http://api.map.baidu.com/images/marker_red_sprite.png",new BMap.Size(23,25));F[I].setZIndex(0);}else{var J=new BMap.Icon("http://source.qunar.com/site/images/t/i/markers.png",new BMap.Size(23,25));F[I].setZIndex(9);A.setCenter(F[I].getPosition());}F[I].setIcon(J);}}function D(L){var K;for(var J=0,I=F.length;J<I;J+=1){if(F[J].guid==L.currentTarget.guid){K=J;}}var q=this,N=parseInt(h[K].id,10);var M=l(".map_tabcontent > li");M.removeClass("current");l.each(M,function(P,O){var Q=M.eq(P);if(parseInt(Q.find("span").attr("data-itemid"),10)==N){Q.addClass("current");}});e(q);z(K);}var p=function(L,I){var q=parseInt(l("#hotelname .current > span").attr("data-itemid"),10);if(typeof L.address=="string"){var K=new BMap.Geocoder();K.getPoint(L.address,function(N){if(N){var M=J(N,q);if(!B){M.addEventListener("click",D);}}},L.city);}function J(N,P){if(P!=L.id){var O=new BMap.Icon("http://api.map.baidu.com/images/marker_red_sprite.png",new BMap.Size(23,25));var M=new BMap.Marker(new BMap.Point(N.lng,N.lat),{icon:O});M.setZIndex(0);}else{var O=new BMap.Icon("http://source.qunar.com/site/images/t/i/markers.png",new BMap.Size(23,25));var M=new BMap.Marker(new BMap.Point(N.lng,N.lat),{icon:O});M.setZIndex(9);}A.setCenter(M.getPosition());if(!E){F.push(M);}A.addOverlay(M);return M;}};function i(q){q.each(function(J,I){if(l.trim(l(I).html())==""){l(I).prev().hide();l(I).hide();}else{l(I).prev().show();l(I).show();}});}function z(q){var I=l("#shop_page > .traffic > dl > dd");if(!!h&&h[q]){if(l.trim(h[q].area3)!==""){I.eq(0).html(h[q].area3);}if(l.trim(h[q].phone)!==""){I.eq(1).html(h[q].phone);}if(l.trim(h[q].bus)!==""){I.eq(2).html(h[q].bus);}if(l.trim(h[q].metro)!==""){I.eq(3).html(h[q].metro);}if(l.trim(h[q].car)!==""){I.eq(4).html(h[q].car);}}i(I);}mapCallback=function(){var L=l("#team_id").val();var K,q,I=l(".city_tab > dl > .current"),J=I.attr("parent_city");if(I.html()&&typeof I.html()=="string"){q=(!!J)?J:l.trim(I.html());}v("map",q);l.ajax({url:"/api/get_all_shop.php",data:{city:encodeURIComponent(q),team_id:L},dataType:"json",success:function(N){var M=N.data.data.length;if(!!N.data.data){h=N.data.data;O(h);}function O(S){var R=S.length;if(!R){p({address:S[0].address,city:q,id:S[0].id},0);B=true;}else{for(var Q=0,P=R;Q<P;Q+=1){p({address:S[Q].area3,city:q,id:S[Q].id},Q);}}}}});};var s=function(){var q=H.createElement("script");q.async=true;q.src="http://api.map.baidu.com/api?v=1.2&callback=mapCallback";H.body.appendChild(q);};function a(){l("#ppt_1").switchable({interval:5,autoplay:true,effect:"none",events:["hover"],circle:true,activeTriggerCls:"current",delay:0});}function n(){G.init(l("#shop_page"),s);}m.init=function(){a();n();m.shop.init();m.city_tab.init();};m.init();})(jQuery);